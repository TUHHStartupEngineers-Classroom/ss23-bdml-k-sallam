{
  "hash": "2359c78bb64205a1250121bfe518dc82",
  "result": {
    "markdown": "---\ntitle: \"05 LIME\"\ndate: \"2023-06-08\"\noutput:\n  html_document:\n    toc: true\n    toc_float: true\n    df_print: paged\n    collapsed: false\n    number_sections: true\n    toc_depth: 3\n    #code_folding: hide\n---\n\n\n\n\n# Load model\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-1_6adc5f7dc94e69a58c7242c317f8b940'}\n\n```{.r .cell-code}\n# LIME FEATURE EXPLANATION ----\n\n# 1. Setup ----\n\n# Load Libraries \n\nlibrary(h2o)\nlibrary(recipes)\nlibrary(readxl)\nlibrary(tidyverse)\nlibrary(tidyquant)\nlibrary(lime)\nlibrary(rsample)\n\nproduct_data <- read_csv(\"./01_ml_fund_source/Business\\ Decisions\\ with\\ Machine\\ Learning/product_backorders.csv\")\nproduct_data2 <- product_data %>% \n  mutate(\n      product_backorder = went_on_backorder %>% str_to_lower() %>% str_detect(\"yes\") %>% as.numeric()\n  ) %>% \n  select(-c(went_on_backorder))\nglimpse(product_data)\n\nsplit_obj<- initial_split(product_data2, prop = 0.75)\ntrain_tbl<- training(split_obj)\ntest_tbl<- testing(split_obj)\n\n\n# ML Preprocessing Recipe \nrecipe_obj <- recipe(product_backorder ~., data = train_tbl) %>% \n    step_zv(all_predictors()) %>% \n    step_dummy(all_nominal(),-all_outcomes()) %>%\n    prep()\n\n\nsplit_obj<- initial_split(product_data2, prop = 0.75)\ntrain_tbl<- training(split_obj)\ntest_tbl<- testing(split_obj)\n```\n:::\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-2_aea520a4bdd8e7fdfa2451e053fb5336'}\n\n```{.r .cell-code}\n# 2. Models ----\n\nh2o.init()\n\nautoml_leader <- h2o.loadModel(\"StackedEnsemble_AllModels_AutoML_20210603_202714/StackedEnsemble_AllModels_AutoML_20210603_210724\")\nautoml_leader\n```\n:::\n\n\n\n# Plot\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-3_761801db3926c5e0087dfd59550350db'}\n\n```{.r .cell-code}\n# 3.1 Making Predictions ----\n\npredictions_tbl <- automl_leader %>% \n    h2o.predict(newdata = as.h2o(test_tbl)) %>%\n    as.tibble() %>%\n    bind_cols(\n        test_tbl %>%\n            select(everything())\n    )\n\npredictions_tbl\n```\n:::\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-4_992b6b1f05cba66d51018e16c7609b06'}\n\n```{.r .cell-code}\nsummary(train_tbl)\n```\n:::\n\n\nTake the explanation data and use the first case to create a plot similar to the output of plot_features().\n\n## Original plot_features()\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-5_319a2c79588bce4c55231fd790e51941'}\n\n```{.r .cell-code}\n# explanation %>% \n#   as.tibble()\n#   \n# case_1 <- explanation %>%\n#     filter(case == 1)\n# \n# case_1 %>%\n#     plot_features()\n# You will need at least the layers geom_col() and coord_flip().\n\nexplainer <- train_tbl %>%\n    select(-product_backorder) %>%\n    lime(\n        model           = automl_leader,\n        bin_continuous  = TRUE,\n        n_bins          = 4,\n        quantile_bins   = TRUE\n    )\n\nexplainer\n\n\nexplanation <- test_tbl %>%\n    slice(1) %>%\n    select(-product_backorder) %>%\n    lime::explain(\n    \n        # Pass our explainer object\n        explainer = explainer,\n        # Because it is a binary classification model: 1\n        n_labels   = 1,\n        # number of features to be returned\n        n_features = 8,\n        # number of localized linear models\n        n_permutations = 5000,\n        # Let's start with 1\n        kernel_width   = 1\n    )\n\nexplanation\n```\n:::\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-6_94564dc31acbb82effe40018cd968d7b'}\n\n```{.r .cell-code}\ng <- plot_features(explanation = explanation, ncol = 1, cases = 1)\ng\n```\n:::\n\n\n\n## Bonus Objectives:\nGet your custom plot_features() function to scale to multiple cases\nUse theme arguments to modify the look of the plot\n\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-7_7f7203e04b3dc4c57a3022b740c84c61'}\n\n```{.r .cell-code}\nexplanation_multi <- test_tbl %>%\n    slice(1:20) %>%\n    select(-product_backorder) %>%\n    lime::explain(\n        explainer = explainer,\n        n_labels   = 1,\n        n_features = 8,\n        n_permutations = 5000,\n        kernel_width   = 0.5\n    )\n\nexplanation_multi %>%\n    as.tibble()\n\nplot_explanations(explanation_multi)\n```\n:::\n\n\n# Part 2: Recreate plot_explanations():\n\nTake the full explanation data and recreate the second plot.\nYou will need at least the layers geom_tile() and facet_wrap().\n\n## Customized plot_features()\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-8_290fb244b2f08d187eacd5c61927015a'}\n\n```{.r .cell-code}\ntheme_lime <- function(...) {\n  theme_minimal() +\n    theme(\n      strip.text = element_text(face = 'bold', size = 9),\n      plot.margin = margin(15, 15, 15, 15),\n      legend.background = element_blank(),\n      legend.key = element_blank(),\n      panel.grid.major.y = element_blank(),\n      panel.grid.minor.y = element_blank(),\n      axis.ticks = element_blank(),\n      legend.position = 'bottom',\n      panel.spacing.y = unit(15, 'pt'),\n      strip.text.x = element_text(margin = margin(t = 2, b = 2), hjust = 0),\n      axis.title.y = element_text(margin = margin(r = 10)),\n      axis.title.x = element_text(margin = margin(t = 10)),\n      panel.background = element_rect(fill   = \"transparent\"),\n      panel.border     = element_rect(color = \"black\", fill = NA, size = 0.5),\n      panel.grid.major = element_line(color = \"grey\", size = 0.333),\n      ...\n    )\n}\n\nplot_explanations_customized <- function(explanation, ...) {\n\n  num_cases <- unique(suppressWarnings(as.numeric(explanation$case)))\n  if (!anyNA(num_cases)) {\n    explanation$case <- factor(explanation$case, levels = as.character(sort(num_cases)))\n  }\n  explanation$feature_desc <- factor(\n    explanation$feature_desc,\n    levels = rev(unique(explanation$feature_desc[order(explanation$feature, explanation$feature_value)]))\n  )\n  \np <- ggplot(explanation, aes_(~case, ~feature_desc),show.legend=TRUE) +\n    geom_tile(aes_(fill = ~feature_weight)) +\n    scale_x_discrete('Case', expand = c(0, 0)) +\n    scale_y_discrete('Feature', expand = c(0, 0)) +\n    scale_fill_gradient2('Feature\\nweight', low = 'firebrick', mid = '#f7f7f7', high = 'steelblue') +\n    theme_lime() +\n    theme(panel.border = element_rect(fill = NA, colour = 'grey60', size = 1),\n          panel.grid = element_blank(),\n          legend.position = 'right',\n          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))\n  if (is.null(explanation$label)) {\n    p\n  } else {\n    p + facet_wrap(~label, ...)\n  }\n}\n```\n:::\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-9_2059899b12c7316ee907e0ae69c39819'}\n\n```{.r .cell-code}\nplot_explanations_customized(explanation = explanation, ncol = 1, cases = 1)\n```\n:::\n\n::: {.cell hash='05_lime_cache/html/unnamed-chunk-10_2f58802a89031d77ed56b648e73c5dc8'}\n\n```{.r .cell-code}\nplot_explanations_customized(explanation_multi)\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}